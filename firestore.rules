rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Protect the emails collection from client-side writes. Cloud Functions
    // using the Admin SDK bypass security rules, so functions can still
    // create these documents while clients are prevented from doing so.
    match /emails/{email} {
      // Allow reads if your app needs to read the reserved emails list.
      allow read: if true;
      // Disallow all client-side writes to emails/*. Only server-side
      // operations (Admin SDK used by Cloud Functions) should create these.
      allow create, update, delete: if false;
    }

    // üó≥Ô∏è Regles per Votaci√≥ Setmanal
    // Col¬∑lecci√≥: voting_meta/{docId} - Metadades de votaci√≥
    match /voting_meta/{docId} {
      // Qualsevol usuari autenticat pot llegir les metadades
      allow read: if request.auth != null;
      // Nom√©s el backend (Cloud Functions) pot escriure
      allow write: if false;
    }

    // Col¬∑lecci√≥: voting_jornades/{jornada} - Dades de cada jornada
    match /voting_jornades/{jornada} {
      // Qualsevol usuari autenticat pot llegir les jornades
      allow read: if request.auth != null;
      // Nom√©s el backend (Cloud Functions) pot escriure
      allow write: if false;
    }

    // Col¬∑lecci√≥: vote_counts/{matchId} - Comptadors de vots
    match /vote_counts/{matchId} {
      // Qualsevol usuari autenticat pot llegir els vots
      allow read: if request.auth != null;
      // Els usuaris autenticats poden incrementar/decrementar vots
      allow write: if request.auth != null;
    }

    // Col¬∑lecci√≥: weekly_focus/{docId} - Focus setmanal (guanyador)
    match /weekly_focus/{docId} {
      // Qualsevol usuari autenticat pot llegir el focus
      allow read: if request.auth != null;
      // Nom√©s el backend (Cloud Functions) pot escriure
      allow write: if false;
    }

    // üó®Ô∏è Regles per Comentaris Col¬∑lectius de la feature Visionat
    // Col¬∑lecci√≥: collective_comments/{matchId}/comments/{commentId}
    match /collective_comments/{matchId}/comments/{commentId} {
      
      // üîê 1. Requisit general: Totes les operacions requereixen autenticaci√≥
      // üü© 2. Permisos de lectura: Qualsevol usuari autenticat pot llegir comentaris
      allow read: if request.auth != null;

      // üüß 3. Permisos de creaci√≥: Nom√©s el creador pot afegir comentaris
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.createdBy
        && request.time == request.resource.data.createdAt
        && isValidCommentCreate(request.resource.data, matchId);

      // üü• 4. Permisos d'actualitzaci√≥: El creador pot modificar el contingut, qualsevol pot fer like
      allow update: if request.auth != null
        && (
          // El creador pot modificar el contingut del comentari
          (request.auth.uid == resource.data.createdBy 
           && isValidCommentUpdate(request.resource.data, resource.data))
          ||
          // Qualsevol usuari pot fer/desfer like (nom√©s canvien likes i likedBy)
          isValidLikeToggle(request.resource.data, resource.data, request.auth.uid)
        );

      // ‚ùå 5. Permisos d'eliminaci√≥: Nom√©s el creador pot eliminar els seus comentaris
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.createdBy;
    }

    // üì¶ Funcions auxiliars per validaci√≥ de comentaris col¬∑lectius
    function isValidCommentCreate(data, matchId) {
      return hasRequiredFieldsCommentCreate(data)
        && hasCorrectTypesCommentCreate(data)
        && data.matchId == matchId
        && data.likes == 0
        && data.likedBy.size() == 0
        && data.isEdited == false;
    }

    function isValidCommentUpdate(newData, oldData) {
      return hasRequiredFieldsCommentUpdate(newData)
        && hasCorrectTypesCommentUpdate(newData)
        && isImmutableCommentFieldsPreserved(newData, oldData)
        // Si s'edita el contingut, marcar com editat
        && (newData.content == oldData.content || newData.isEdited == true);
    }

    function isValidLikeToggle(newData, oldData, userId) {
      return onlyLikeFieldsChanged(newData, oldData)
        && isValidLikeOperation(newData, oldData, userId);
    }

    // Validaci√≥ que nom√©s canvi√Øn els camps de like
    function onlyLikeFieldsChanged(newData, oldData) {
      let unchangedFields = newData.diff(oldData).unchangedKeys();
      let requiredUnchanged = [
        'id', 'matchId', 'content', 'tagId', 'tagLabel', 
        'createdBy', 'createdByName', 'createdAt', 'isEdited'
      ];
      return unchangedFields.hasAll(requiredUnchanged);
    }

    // Validaci√≥ de l'operaci√≥ de like (afegir o treure like)
    function isValidLikeOperation(newData, oldData, userId) {
      let oldLikedBy = oldData.likedBy;
      let newLikedBy = newData.likedBy;
      let wasLiked = oldLikedBy.hasAny([userId]);
      let isNowLiked = newLikedBy.hasAny([userId]);
      
      // Afegir like: l'usuari no tenia like i ara s√≠
      let addingLike = !wasLiked && isNowLiked 
        && newData.likes == oldData.likes + 1
        && newLikedBy.toSet().difference(oldLikedBy.toSet()) == [userId].toSet();
      
      // Treure like: l'usuari tenia like i ara no
      let removingLike = wasLiked && !isNowLiked 
        && newData.likes == oldData.likes - 1
        && oldLikedBy.toSet().difference(newLikedBy.toSet()) == [userId].toSet();
      
      return addingLike || removingLike;
    }

    // Validaci√≥ de camps obligatoris per creaci√≥ de comentaris
    function hasRequiredFieldsCommentCreate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'content', 'tagId', 'tagLabel',
        'createdBy', 'createdByName', 'createdAt', 'likes', 'likedBy', 'isEdited'
      ]);
    }

    // Validaci√≥ de camps obligatoris per actualitzaci√≥ de comentaris
    function hasRequiredFieldsCommentUpdate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'content', 'tagId', 'tagLabel',
        'createdBy', 'createdByName', 'createdAt', 'likes', 'likedBy', 'isEdited'
      ]);
    }

    // Validaci√≥ de tipus correctes per creaci√≥ de comentaris
    function hasCorrectTypesCommentCreate(data) {
      return data.id is string
        && data.matchId is string
        && data.content is string
        && data.tagId is string
        && data.tagLabel is string
        && data.createdBy is string
        && data.createdByName is string
        && data.createdAt is timestamp
        && data.likes is number
        && data.likedBy is list
        && data.isEdited is bool;
    }

    // Validaci√≥ de tipus correctes per actualitzaci√≥ de comentaris
    function hasCorrectTypesCommentUpdate(data) {
      return data.id is string
        && data.matchId is string
        && data.content is string
        && data.tagId is string
        && data.tagLabel is string
        && data.createdBy is string
        && data.createdByName is string
        && data.createdAt is timestamp
        && data.likes is number
        && data.likedBy is list
        && data.isEdited is bool;
    }

    // Validaci√≥ que els camps immutables de comentaris no es modifiquin
    function isImmutableCommentFieldsPreserved(newData, oldData) {
      return newData.createdBy == oldData.createdBy
        && newData.createdAt == oldData.createdAt
        && newData.matchId == oldData.matchId
        && newData.id == oldData.id
        && newData.createdByName == oldData.createdByName
        && newData.tagId == oldData.tagId
        && newData.tagLabel == oldData.tagLabel;
    }

    // üîí Regles per Personal Analysis de la feature Visionat
    // Col¬∑lecci√≥: personal_analysis/{analysisId}
    match /personal_analysis/{analysisId} {
      
      // üîê 1. Requisit general: Totes les operacions requereixen autenticaci√≥
      // üìö 2. Permisos de lectura: Nom√©s l'usuari propietari pot llegir els seus apunts
      allow read: if request.auth != null
        && request.auth.uid == resource.data.userId;

      // üÜï 3. Permisos de creaci√≥: Nom√©s l'usuari pot crear els seus propis apunts
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId
        && request.time == request.resource.data.createdAt
        && isValidPersonalAnalysisCreate(request.resource.data);

      // ‚úèÔ∏è 4. Permisos d'actualitzaci√≥: Nom√©s l'usuari propietari pot modificar els seus apunts
      allow update: if request.auth != null
        && request.auth.uid == resource.data.userId
        && request.auth.uid == request.resource.data.userId
        && isValidPersonalAnalysisUpdate(request.resource.data, resource.data);

      // üóëÔ∏è 5. Permisos d'eliminaci√≥: Nom√©s l'usuari propietari pot eliminar els seus apunts
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.userId;
    }

    // üì¶ Funcions auxiliars per validaci√≥ d'apunts personals
    function isValidPersonalAnalysisCreate(data) {
      return hasRequiredFieldsPersonalAnalysisCreate(data)
        && hasCorrectTypesPersonalAnalysisCreate(data);
    }

    function isValidPersonalAnalysisUpdate(newData, oldData) {
      return hasRequiredFieldsPersonalAnalysisUpdate(newData)
        && hasCorrectTypesPersonalAnalysisUpdate(newData)
        && isImmutablePersonalAnalysisFieldsPreserved(newData, oldData);
    }

    // Validaci√≥ de camps obligatoris per creaci√≥ d'apunts personals
    function hasRequiredFieldsPersonalAnalysisCreate(data) {
      return data.keys().hasAll([
        'userId', 'matchId', 'jornadaId', 'text', 'tags',
        'createdAt', 'userDisplayName', 'isEdited'
      ]);
    }

    // Validaci√≥ de camps obligatoris per actualitzaci√≥ d'apunts personals
    function hasRequiredFieldsPersonalAnalysisUpdate(data) {
      return data.keys().hasAll([
        'userId', 'matchId', 'jornadaId', 'text', 'tags',
        'createdAt', 'userDisplayName', 'isEdited'
      ]);
    }

    // Validaci√≥ de tipus correctes per creaci√≥ d'apunts personals
    function hasCorrectTypesPersonalAnalysisCreate(data) {
      return data.userId is string
        && data.matchId is string
        && data.jornadaId is string
        && data.text is string
        && data.tags is list
        && data.createdAt is timestamp
        && data.userDisplayName is string
        && data.isEdited is bool;
    }

    // Validaci√≥ de tipus correctes per actualitzaci√≥ d'apunts personals
    function hasCorrectTypesPersonalAnalysisUpdate(data) {
      return data.userId is string
        && data.matchId is string
        && data.jornadaId is string
        && data.text is string
        && data.tags is list
        && data.createdAt is timestamp
        && data.userDisplayName is string
        && data.isEdited is bool;
    }

    // Validaci√≥ que els camps immutables d'apunts personals no es modifiquin
    function isImmutablePersonalAnalysisFieldsPreserved(newData, oldData) {
      return newData.userId == oldData.userId
        && newData.matchId == oldData.matchId
        && newData.jornadaId == oldData.jornadaId
        && newData.createdAt == oldData.createdAt
        && newData.userDisplayName == oldData.userDisplayName;
    }

    // üéÆ Regles per Highlights amb Sistema de Reaccions i Comentaris
    // Col¬∑lecci√≥: entries/{matchId}/entries/{highlightId}
    match /entries/{matchId}/entries/{highlightId} {

      // üîê 1. Requisit general: Totes les operacions requereixen autenticaci√≥
      // üü© 2. Permisos de lectura: Qualsevol usuari autenticat pot llegir highlights
      allow read: if request.auth != null;

      // üüß 3. Permisos de creaci√≥: Qualsevol √†rbitre autenticat pot crear highlights
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.createdBy
        && isValidHighlightPlayCreate(request.resource.data, matchId);

      // üü• 4. Permisos d'actualitzaci√≥:
      // - Qualsevol pot afegir/treure reaccions
      // - Nom√©s creador pot modificar contingut
      // - Cloud Functions poden canviar status
      allow update: if request.auth != null
        && (
          // Usuaris poden toggle reaccions
          isValidReactionToggle(request.resource.data, resource.data)
          ||
          // Creador pot modificar el highlight
          (request.auth.uid == resource.data.createdBy
           && isValidHighlightPlayUpdate(request.resource.data, resource.data))
          ||
          // Cloud Functions poden canviar status (server-side)
          isServerSideStatusUpdate(request.resource.data)
        );

      // ‚ùå 5. Permisos d'eliminaci√≥: Nom√©s el creador pot eliminar
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.createdBy;

      // Subco≈Älecci√≥ de comentaris d'√†rbitres (sistema antic)
      match /referee_comments/{commentId} {
        // Qualsevol autenticat pot llegir comentaris
        allow read: if request.auth != null;

        // Nom√©s √†rbitres registrats poden crear comentaris
        allow create: if request.auth != null
          && request.auth.uid == request.resource.data.userId
          && isValidRefereeComment(request.resource.data, commentId);

        // Nom√©s el creador pot editar (si no √©s oficial)
        allow update: if request.auth != null
          && request.auth.uid == resource.data.userId
          && !resource.data.isOfficial
          && isValidCommentEdit(request.resource.data, resource.data);

        // Nom√©s el creador pot eliminar (si no √©s oficial)
        allow delete: if request.auth != null
          && request.auth.uid == resource.data.userId
          && !resource.data.isOfficial;
      }

      // Subco≈Älecci√≥ de comentaris amb debat (sistema nou)
      match /comments/{commentId} {
        // Qualsevol autenticat pot llegir comentaris
        allow read: if request.auth != null;

        // Qualsevol autenticat pot crear comentaris
        allow create: if request.auth != null
          && request.auth.uid == request.resource.data.userId
          && isValidDebateCommentCreate(request.resource.data);

        // El creador pot editar el seu comentari (nom√©s el text)
        allow update: if request.auth != null
          && request.auth.uid == resource.data.userId
          && isValidDebateCommentUpdate(request.resource.data, resource.data);

        // El creador pot eliminar el seu comentari
        allow delete: if request.auth != null
          && request.auth.uid == resource.data.userId;

        // Subco≈Älecci√≥ de likes
        match /likes/{likeId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null
            && likeId == request.auth.uid
            && request.resource.data.userId == request.auth.uid;
          allow delete: if request.auth != null
            && likeId == request.auth.uid;
        }
      }
    }

    // üì¶ Funcions auxiliars per validaci√≥ de highlights amb reaccions
    function isValidHighlightPlayCreate(data, matchId) {
      return data.matchId == matchId
        && data.createdBy is string
        && data.createdAt is timestamp
        && data.title is string
        && data.timestamp is number;
    }

    function isValidHighlightPlayUpdate(newData, oldData) {
      return newData.createdBy == oldData.createdBy
        && newData.createdAt == oldData.createdAt
        && newData.matchId == oldData.matchId
        && newData.id == oldData.id;
    }

    function isValidReactionToggle(newData, oldData) {
      // Nom√©s canvien reactions i reactionsSummary
      let unchangedFields = newData.diff(oldData).unchangedKeys();
      let requiredUnchanged = [
        'id', 'matchId', 'title', 'timestamp', 'createdBy', 'createdAt'
      ];
      return unchangedFields.hasAll(requiredUnchanged)
        && newData.reactions is list
        && newData.reactionsSummary is map;
    }

    function isServerSideStatusUpdate(newData) {
      // Nom√©s canvia status, reviewNotifiedAt, resolvedAt, officialCommentId
      // Aquest check √©s relaxat perqu√® les Cloud Functions usen Admin SDK
      return newData.status is string
        && newData.status in ['open', 'under_review', 'resolved'];
    }

    function isValidRefereeComment(data, commentId) {
      return data.id == commentId
        && data.userId is string
        && data.category is string
        && data.comment is string
        && data.comment.size() >= 50
        && data.isAnonymous is bool
        && data.isOfficial is bool
        && data.createdAt is timestamp;
    }

    function isValidCommentEdit(newData, oldData) {
      return newData.userId == oldData.userId
        && newData.id == oldData.id
        && newData.createdAt == oldData.createdAt
        && newData.category == oldData.category
        && newData.isOfficial == oldData.isOfficial
        && newData.comment is string
        && newData.comment.size() >= 50;
    }

    // üîî Regles per Notificacions In-App
    // Col¬∑lecci√≥: notifications/{notificationId}
    match /notifications/{notificationId} {
      // Nom√©s el destinatari pot llegir les seves notificacions
      allow read: if request.auth != null
        && request.auth.uid == resource.data.userId;

      // Nom√©s Cloud Functions poden crear notificacions (client-side NO)
      allow create: if false;

      // El destinatari pot marcar com llegida
      allow update: if request.auth != null
        && request.auth.uid == resource.data.userId
        && request.resource.data.userId == resource.data.userId
        && isValidNotificationUpdate(request.resource.data, resource.data);

      // El destinatari pot eliminar les seves notificacions
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.userId;
    }

    function isValidNotificationUpdate(newData, oldData) {
      // Nom√©s pot canviar isRead
      let unchangedFields = newData.diff(oldData).unchangedKeys();
      let requiredUnchanged = [
        'id', 'userId', 'type', 'title', 'message', 'data', 'createdAt', 'expiresAt'
      ];
      return unchangedFields.hasAll(requiredUnchanged)
        && newData.isRead is bool;
    }

    // üì¶ Funcions auxiliars per validaci√≥ de comentaris de debat
    function isValidDebateCommentCreate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'highlightId', 'userId', 'userName',
        'userCategory', 'text', 'isOfficial', 'likesCount',
        'repliesCount', 'createdAt'
      ])
      && data.id is string
      && data.matchId is string
      && data.highlightId is string
      && data.userId is string
      && data.userName is string
      && data.userCategory is string
      && data.text is string
      && data.text.size() > 0
      && data.isOfficial is bool
      && data.likesCount == 0
      && data.repliesCount == 0
      && data.createdAt is timestamp;
    }

    function isValidDebateCommentUpdate(newData, oldData) {
      // Nom√©s pot canviar el text i updatedAt
      return newData.id == oldData.id
        && newData.matchId == oldData.matchId
        && newData.highlightId == oldData.highlightId
        && newData.userId == oldData.userId
        && newData.userName == oldData.userName
        && newData.userCategory == oldData.userCategory
        && newData.isOfficial == oldData.isOfficial
        && newData.createdAt == oldData.createdAt
        && newData.text is string
        && newData.text.size() > 0;
    }

    // üì∫ Regles per Tracking de Clips Vistos de YouTube
    // Col¬∑lecci√≥: watched_clips/{userId_videoId}
    match /watched_clips/{clipId} {
      // Nom√©s l'usuari propietari pot llegir els seus clips vistos
      allow read: if request.auth != null
        && request.auth.uid == resource.data.userId;

      // Nom√©s l'usuari pot marcar els seus propis clips com a vistos
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId
        && isValidWatchedClipCreate(request.resource.data, clipId);

      // No es permet actualitzaci√≥ (nom√©s creaci√≥ i eliminaci√≥)
      allow update: if false;

      // Nom√©s l'usuari propietari pot desmarcar els seus clips vistos
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.userId;
    }

    // ‚ùì Regles per Laboratori Arbitral (Quiz)
    // Col¬∑lecci√≥: quiz_questions/{questionId}
    match /quiz_questions/{questionId} {
      // Qualsevol usuari autenticat pot llegir (per fer el quiz)
      allow read: if request.auth != null;
      
      // Qualsevol usuari autenticat pot actualitzar (per col¬∑laborar en l'Editor)
      // TODO: En futur restringir a admins o testers espec√≠fics
      allow update: if request.auth != null;
      
      // Creaci√≥ i eliminaci√≥ restringida (nom√©s admins o scripts)
      allow create, delete: if true; // Mantinc el "true" del catch-all per ara
    }

    // üì¶ Funcions auxiliars per validaci√≥ de clips vistos
    function isValidWatchedClipCreate(data, clipId) {
      return data.keys().hasAll(['userId', 'videoId', 'watchedAt'])
        && data.userId is string
        && data.videoId is string
        && data.watchedAt is timestamp
        && clipId == data.userId + '_' + data.videoId; // Validar format del document ID
    }

    match /{document=**} {
      // ‚ö†Ô∏è Nom√©s per desenvolupament local (altres col¬∑leccions continuen obertes)
      allow read, write: if true;
    }
  }
}