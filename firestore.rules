rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // FUNCIONS AUXILIARS GLOBALS
    // ============================================================

    // Comprova si l'usuari est√† autenticat
    function isAuth() {
      return request.auth != null;
    }

    // Comprova si l'usuari √©s el propietari (comparant amb un camp userId)
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // ============================================================
    // üìß EMAILS (reservats pel sistema)
    // ============================================================
    match /emails/{email} {
      allow read: if true;
      allow create, update, delete: if false;
    }

    // ============================================================
    // üë§ USERS (perfils d'usuari)
    // ============================================================
    match /users/{uid} {
      // Qualsevol autenticat pot llegir perfils (per mentoria, perfils p√∫blics)
      allow read: if isAuth();
      // Nom√©s el propi usuari pot modificar el seu perfil
      allow update: if isOwner(uid);
      // Creaci√≥ i eliminaci√≥ nom√©s via Cloud Functions (completeRegistration)
      allow create, delete: if false;

      // Subcol¬∑lecci√≥: timeblocks (Gestiona't)
      match /timeblocks/{blockId} {
        allow read, write: if isOwner(uid);
      }

      // Subcol¬∑lecci√≥: designacions
      match /designations/{designationId} {
        allow read, write: if isOwner(uid);
      }

      // Subcol¬∑lecci√≥: sessions de mentoria
      match /mentorship_sessions/{sessionId} {
        allow read, write: if isOwner(uid);
      }

      // Subcol¬∑lecci√≥: video clips
      match /video_clips/{clipId} {
        allow read: if isAuth();
        allow write: if isOwner(uid);
      }
    }

    // ============================================================
    // üó≥Ô∏è VOTACI√ì SETMANAL
    // ============================================================

    // Metadades de votaci√≥ (nom√©s lectura per clients)
    match /voting_meta/{docId} {
      allow read: if isAuth();
      allow write: if false;
    }

    // Dades de cada jornada (nom√©s lectura per clients)
    match /voting_jornades/{jornada} {
      allow read: if isAuth();
      allow write: if false;
    }

    // Comptadors de vots (actualitzats pel trigger onVoteWrite, no pel client)
    match /vote_counts/{countId} {
      allow read: if isAuth();
      allow write: if false;
    }

    // Vots individuals: doc ID = {jornada}_{userId}
    match /votes/{voteId} {
      allow read: if isAuth()
        && resource.data.userId == request.auth.uid;

      allow create: if isAuth()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.jornada is number
        && request.resource.data.matchId is string;

      allow update: if isAuth()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;

      allow delete: if isAuth()
        && resource.data.userId == request.auth.uid;
    }

    // Focus setmanal - guanyador (nom√©s lectura per clients)
    match /weekly_focus/{docId} {
      allow read: if isAuth();
      allow write: if false;
    }

    // ============================================================
    // üìä INFORMES I TESTS
    // ============================================================

    // Informes d'avaluaci√≥ arbitral
    match /reports/{reportId} {
      // Cada usuari llegeix/escriu nom√©s els seus propis informes
      allow read: if isAuth()
        && resource.data.userId == request.auth.uid;
      allow create: if isAuth()
        && request.resource.data.userId == request.auth.uid;
      // Permetre update perqu√® processPdfOnUpload (Admin SDK) actualitza,
      // per√≤ el client tamb√© fa set() que pot ser create o update
      allow update: if isAuth()
        && resource.data.userId == request.auth.uid;
      allow delete: if isAuth()
        && resource.data.userId == request.auth.uid;
    }

    // Tests te√≤rics
    match /tests/{testId} {
      allow read: if isAuth()
        && resource.data.userId == request.auth.uid;
      allow create: if isAuth()
        && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth()
        && resource.data.userId == request.auth.uid;
      allow delete: if isAuth()
        && resource.data.userId == request.auth.uid;
    }

    // Seguiment de millora: doc ID = {userId}_{season}
    match /improvement_tracking/{trackingId} {
      allow read: if isAuth()
        && resource.data.userId == request.auth.uid;
      allow create: if isAuth()
        && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth()
        && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    // ============================================================
    // üó®Ô∏è COMENTARIS COL¬∑LECTIUS (feature Visionat)
    // ============================================================
    match /collective_comments/{matchId}/comments/{commentId} {
      allow read: if isAuth();

      allow create: if isAuth()
        && request.auth.uid == request.resource.data.createdBy
        && request.time == request.resource.data.createdAt
        && isValidCommentCreate(request.resource.data, matchId);

      allow update: if isAuth()
        && (
          (request.auth.uid == resource.data.createdBy
           && isValidCommentUpdate(request.resource.data, resource.data))
          ||
          isValidLikeToggle(request.resource.data, resource.data, request.auth.uid)
        );

      allow delete: if isAuth()
        && request.auth.uid == resource.data.createdBy;
    }

    function isValidCommentCreate(data, matchId) {
      return hasRequiredFieldsCommentCreate(data)
        && hasCorrectTypesCommentCreate(data)
        && data.matchId == matchId
        && data.likes == 0
        && data.likedBy.size() == 0
        && data.isEdited == false;
    }

    function isValidCommentUpdate(newData, oldData) {
      return hasRequiredFieldsCommentUpdate(newData)
        && hasCorrectTypesCommentUpdate(newData)
        && isImmutableCommentFieldsPreserved(newData, oldData)
        && (newData.content == oldData.content || newData.isEdited == true);
    }

    function isValidLikeToggle(newData, oldData, userId) {
      return onlyLikeFieldsChanged(newData, oldData)
        && isValidLikeOperation(newData, oldData, userId);
    }

    function onlyLikeFieldsChanged(newData, oldData) {
      let unchangedFields = newData.diff(oldData).unchangedKeys();
      let requiredUnchanged = [
        'id', 'matchId', 'content', 'tagId', 'tagLabel',
        'createdBy', 'createdByName', 'createdAt', 'isEdited'
      ];
      return unchangedFields.hasAll(requiredUnchanged);
    }

    function isValidLikeOperation(newData, oldData, userId) {
      let oldLikedBy = oldData.likedBy;
      let newLikedBy = newData.likedBy;
      let wasLiked = oldLikedBy.hasAny([userId]);
      let isNowLiked = newLikedBy.hasAny([userId]);

      let addingLike = !wasLiked && isNowLiked
        && newData.likes == oldData.likes + 1
        && newLikedBy.toSet().difference(oldLikedBy.toSet()) == [userId].toSet();

      let removingLike = wasLiked && !isNowLiked
        && newData.likes == oldData.likes - 1
        && oldLikedBy.toSet().difference(newLikedBy.toSet()) == [userId].toSet();

      return addingLike || removingLike;
    }

    function hasRequiredFieldsCommentCreate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'content', 'tagId', 'tagLabel',
        'createdBy', 'createdByName', 'createdAt', 'likes', 'likedBy', 'isEdited'
      ]);
    }

    function hasRequiredFieldsCommentUpdate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'content', 'tagId', 'tagLabel',
        'createdBy', 'createdByName', 'createdAt', 'likes', 'likedBy', 'isEdited'
      ]);
    }

    function hasCorrectTypesCommentCreate(data) {
      return data.id is string
        && data.matchId is string
        && data.content is string
        && data.tagId is string
        && data.tagLabel is string
        && data.createdBy is string
        && data.createdByName is string
        && data.createdAt is timestamp
        && data.likes is number
        && data.likedBy is list
        && data.isEdited is bool;
    }

    function hasCorrectTypesCommentUpdate(data) {
      return data.id is string
        && data.matchId is string
        && data.content is string
        && data.tagId is string
        && data.tagLabel is string
        && data.createdBy is string
        && data.createdByName is string
        && data.createdAt is timestamp
        && data.likes is number
        && data.likedBy is list
        && data.isEdited is bool;
    }

    function isImmutableCommentFieldsPreserved(newData, oldData) {
      return newData.createdBy == oldData.createdBy
        && newData.createdAt == oldData.createdAt
        && newData.matchId == oldData.matchId
        && newData.id == oldData.id
        && newData.createdByName == oldData.createdByName
        && newData.tagId == oldData.tagId
        && newData.tagLabel == oldData.tagLabel;
    }

    // ============================================================
    // üîí PERSONAL ANALYSIS (feature Visionat)
    // Path real: personal_analysis/{userId}/entries/{analysisId}
    // ============================================================
    match /personal_analysis/{userId}/entries/{analysisId} {
      allow read: if isOwner(userId);

      allow create: if isOwner(userId)
        && request.auth.uid == request.resource.data.userId
        && isValidPersonalAnalysisCreate(request.resource.data);

      allow update: if isOwner(userId)
        && request.auth.uid == request.resource.data.userId
        && isValidPersonalAnalysisUpdate(request.resource.data, resource.data);

      allow delete: if isOwner(userId);
    }

    function isValidPersonalAnalysisCreate(data) {
      return hasRequiredFieldsPersonalAnalysisCreate(data)
        && hasCorrectTypesPersonalAnalysisCreate(data);
    }

    function isValidPersonalAnalysisUpdate(newData, oldData) {
      return hasRequiredFieldsPersonalAnalysisUpdate(newData)
        && hasCorrectTypesPersonalAnalysisUpdate(newData)
        && isImmutablePersonalAnalysisFieldsPreserved(newData, oldData);
    }

    function hasRequiredFieldsPersonalAnalysisCreate(data) {
      return data.keys().hasAll([
        'userId', 'matchId', 'jornadaId', 'text', 'tags',
        'createdAt', 'userDisplayName', 'isEdited'
      ]);
    }

    function hasRequiredFieldsPersonalAnalysisUpdate(data) {
      return data.keys().hasAll([
        'userId', 'matchId', 'jornadaId', 'text', 'tags',
        'createdAt', 'userDisplayName', 'isEdited'
      ]);
    }

    function hasCorrectTypesPersonalAnalysisCreate(data) {
      return data.userId is string
        && data.matchId is string
        && data.jornadaId is string
        && data.text is string
        && data.tags is list
        && data.createdAt is timestamp
        && data.userDisplayName is string
        && data.isEdited is bool;
    }

    function hasCorrectTypesPersonalAnalysisUpdate(data) {
      return data.userId is string
        && data.matchId is string
        && data.jornadaId is string
        && data.text is string
        && data.tags is list
        && data.createdAt is timestamp
        && data.userDisplayName is string
        && data.isEdited is bool;
    }

    function isImmutablePersonalAnalysisFieldsPreserved(newData, oldData) {
      return newData.userId == oldData.userId
        && newData.matchId == oldData.matchId
        && newData.jornadaId == oldData.jornadaId
        && newData.createdAt == oldData.createdAt
        && newData.userDisplayName == oldData.userDisplayName;
    }

    // ============================================================
    // üìà ANALYZED MATCHES (partits analitzats per usuari)
    // Path: analyzed_matches/{userId}/entries/{matchId}
    // ============================================================
    match /analyzed_matches/{userId}/entries/{matchId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // ============================================================
    // üéÆ HIGHLIGHTS amb Reaccions i Comentaris
    // ============================================================
    match /entries/{matchId}/entries/{highlightId} {
      allow read: if isAuth();

      allow create: if isAuth()
        && request.auth.uid == request.resource.data.createdBy
        && isValidHighlightPlayCreate(request.resource.data, matchId);

      allow update: if isAuth()
        && (
          isValidReactionToggle(request.resource.data, resource.data)
          ||
          (request.auth.uid == resource.data.createdBy
           && isValidHighlightPlayUpdate(request.resource.data, resource.data))
          ||
          isServerSideStatusUpdate(request.resource.data)
        );

      allow delete: if isAuth()
        && request.auth.uid == resource.data.createdBy;

      // Comentaris d'√†rbitres (sistema antic)
      match /referee_comments/{commentId} {
        allow read: if isAuth();
        allow create: if isAuth()
          && request.auth.uid == request.resource.data.userId
          && isValidRefereeComment(request.resource.data, commentId);
        allow update: if isAuth()
          && request.auth.uid == resource.data.userId
          && !resource.data.isOfficial
          && isValidCommentEdit(request.resource.data, resource.data);
        allow delete: if isAuth()
          && request.auth.uid == resource.data.userId
          && !resource.data.isOfficial;
      }

      // Comentaris amb debat (sistema nou)
      match /comments/{commentId} {
        allow read: if isAuth();
        allow create: if isAuth()
          && request.auth.uid == request.resource.data.userId
          && isValidDebateCommentCreate(request.resource.data);
        allow update: if isAuth()
          && request.auth.uid == resource.data.userId
          && isValidDebateCommentUpdate(request.resource.data, resource.data);
        allow delete: if isAuth()
          && request.auth.uid == resource.data.userId;

        // Likes de comentaris
        match /likes/{likeId} {
          allow read: if isAuth();
          allow create: if isAuth()
            && likeId == request.auth.uid
            && request.resource.data.userId == request.auth.uid;
          allow delete: if isAuth()
            && likeId == request.auth.uid;
        }
      }
    }

    function isValidHighlightPlayCreate(data, matchId) {
      return data.matchId == matchId
        && data.createdBy is string
        && data.createdAt is timestamp
        && data.title is string
        && data.timestamp is number;
    }

    function isValidHighlightPlayUpdate(newData, oldData) {
      return newData.createdBy == oldData.createdBy
        && newData.createdAt == oldData.createdAt
        && newData.matchId == oldData.matchId
        && newData.id == oldData.id;
    }

    function isValidReactionToggle(newData, oldData) {
      let unchangedFields = newData.diff(oldData).unchangedKeys();
      let requiredUnchanged = [
        'id', 'matchId', 'title', 'timestamp', 'createdBy', 'createdAt'
      ];
      return unchangedFields.hasAll(requiredUnchanged)
        && newData.reactions is list
        && newData.reactionsSummary is map;
    }

    function isServerSideStatusUpdate(newData) {
      return newData.status is string
        && newData.status in ['open', 'under_review', 'resolved'];
    }

    function isValidRefereeComment(data, commentId) {
      return data.id == commentId
        && data.userId is string
        && data.category is string
        && data.comment is string
        && data.comment.size() >= 50
        && data.isAnonymous is bool
        && data.isOfficial is bool
        && data.createdAt is timestamp;
    }

    function isValidCommentEdit(newData, oldData) {
      return newData.userId == oldData.userId
        && newData.id == oldData.id
        && newData.createdAt == oldData.createdAt
        && newData.category == oldData.category
        && newData.isOfficial == oldData.isOfficial
        && newData.comment is string
        && newData.comment.size() >= 50;
    }

    function isValidDebateCommentCreate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'highlightId', 'userId', 'userName',
        'userCategory', 'text', 'isOfficial', 'likesCount',
        'repliesCount', 'createdAt'
      ])
      && data.id is string
      && data.matchId is string
      && data.highlightId is string
      && data.userId is string
      && data.userName is string
      && data.userCategory is string
      && data.text is string
      && data.text.size() > 0
      && data.isOfficial is bool
      && data.likesCount == 0
      && data.repliesCount == 0
      && data.createdAt is timestamp;
    }

    function isValidDebateCommentUpdate(newData, oldData) {
      return newData.id == oldData.id
        && newData.matchId == oldData.matchId
        && newData.highlightId == oldData.highlightId
        && newData.userId == oldData.userId
        && newData.userName == oldData.userName
        && newData.userCategory == oldData.userCategory
        && newData.isOfficial == oldData.isOfficial
        && newData.createdAt == oldData.createdAt
        && newData.text is string
        && newData.text.size() > 0;
    }

    // ============================================================
    // üîî NOTIFICACIONS IN-APP
    // ============================================================
    match /notifications/{notificationId} {
      allow read: if isAuth()
        && request.auth.uid == resource.data.userId;
      allow create: if false;
      allow update: if isAuth()
        && request.auth.uid == resource.data.userId
        && request.resource.data.userId == resource.data.userId
        && isValidNotificationUpdate(request.resource.data, resource.data);
      allow delete: if isAuth()
        && request.auth.uid == resource.data.userId;
    }

    function isValidNotificationUpdate(newData, oldData) {
      let unchangedFields = newData.diff(oldData).unchangedKeys();
      let requiredUnchanged = [
        'id', 'userId', 'type', 'title', 'message', 'data', 'createdAt', 'expiresAt'
      ];
      return unchangedFields.hasAll(requiredUnchanged)
        && newData.isRead is bool;
    }

    // ============================================================
    // üì∫ TRACKING CLIPS VISTOS (YouTube)
    // ============================================================
    match /watched_clips/{clipId} {
      allow read: if isAuth()
        && request.auth.uid == resource.data.userId;
      allow create: if isAuth()
        && request.auth.uid == request.resource.data.userId
        && isValidWatchedClipCreate(request.resource.data, clipId);
      allow update: if false;
      allow delete: if isAuth()
        && request.auth.uid == resource.data.userId;
    }

    function isValidWatchedClipCreate(data, clipId) {
      return data.keys().hasAll(['userId', 'videoId', 'watchedAt'])
        && data.userId is string
        && data.videoId is string
        && data.watchedAt is timestamp
        && clipId == data.userId + '_' + data.videoId;
    }

    // ============================================================
    // ‚ùì LABORATORI ARBITRAL (Quiz)
    // ============================================================

    // Preguntes del quiz
    match /quiz_questions/{questionId} {
      // Qualsevol autenticat pot llegir (per fer el quiz)
      allow read: if isAuth();
      // Autenticats poden actualitzar (col¬∑laboraci√≥ beta per omplir opcions falses)
      allow update: if isAuth();
      // Creaci√≥ i eliminaci√≥ nom√©s via scripts/Admin SDK
      allow create, delete: if false;
    }

    // Estad√≠stiques de preguntes
    match /questions_stats/{questionId} {
      allow read: if isAuth();
      // El client actualitza stats via transacci√≥ quan respon preguntes
      allow create, update: if isAuth();
      allow delete: if false;
    }

    // Estad√≠stiques de quiz per usuari (subcol¬∑leccions dins users)
    match /users/{uid}/quiz_history/{historyId} {
      allow read, create: if isOwner(uid);
      allow update, delete: if false;
    }
    match /users/{uid}/quiz_stats_by_article/{articleId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid);
      allow delete: if false;
    }
    match /users/{uid}/quiz_stats_global/{docId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid);
      allow delete: if false;
    }

    // Batalles mensuals de reglament
    match /monthly_battles/{battleId} {
      // Qualsevol autenticat pot llegir (veure batalla, r√†nquing)
      allow read: if isAuth();
      // Autenticats poden crear batalles (auto-creaci√≥ si no n'hi ha)
      allow create: if isAuth();
      // Actualitzaci√≥ per incrementar participantCount (via transacci√≥)
      allow update: if isAuth();
      allow delete: if false;

      // Resultats dels participants
      match /results/{userId} {
        // Qualsevol autenticat pot llegir (r√†nquing p√∫blic)
        allow read: if isAuth();
        // Nom√©s el propi usuari pot crear el seu resultat
        allow create: if isAuth()
          && request.auth.uid == userId
          && request.resource.data.userId == request.auth.uid;
        // No es pot modificar ni esborrar (un sol intent)
        allow update, delete: if false;
      }
    }

    // ============================================================
    // üõçÔ∏è COMANDES (Vestidor / Stripe)
    // ============================================================
    match /orders/{orderId} {
      // Cada usuari pot llegir les seves comandes
      allow read: if isAuth()
        && resource.data.uid == request.auth.uid;
      // Nom√©s Cloud Functions (stripeWebhook) poden escriure
      allow write: if false;
    }

    // ============================================================
    // üìã REGISTRE D'√ÄRBITRES I SOL¬∑LICITUDS
    // ============================================================

    // Registre d'√†rbitres (lookup de llic√®ncies)
    match /referees_registry/{registryId} {
      // Lectura per autenticats (cerques de llic√®ncia, mentoria)
      allow read: if isAuth();
      // Nom√©s Cloud Functions (completeRegistration) pot escriure
      allow write: if false;
    }

    // Sol¬∑licituds de registre (completament server-side)
    match /registration_requests/{requestId} {
      allow read, write: if false;
    }

    // ============================================================
    // üö´ DENY-ALL PER DEFECTE
    // Qualsevol col¬∑lecci√≥ no mencionada expl√≠citament queda bloquejada
    // Les Cloud Functions amb Admin SDK bypassen aquestes regles
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
