rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Protect the emails collection from client-side writes. Cloud Functions
    // using the Admin SDK bypass security rules, so functions can still
    // create these documents while clients are prevented from doing so.
    match /emails/{email} {
      // Allow reads if your app needs to read the reserved emails list.
      allow read: if true;
      // Disallow all client-side writes to emails/*. Only server-side
      // operations (Admin SDK used by Cloud Functions) should create these.
      allow create, update, delete: if false;
    }

    // üéØ Regles per Highlights de la feature Visionat
    // Col¬∑lecci√≥: highlights/{matchId}/entries/{highlightId}
    match /highlights/{matchId}/entries/{highlightId} {
      
      // üîê 1. Requisit general: Totes les operacions requereixen autenticaci√≥
      // üü© 2. Permisos de lectura: Qualsevol usuari autenticat pot llegir highlights
      allow read: if request.auth != null;

      // üüß 3. Permisos de creaci√≥: Nom√©s el creador pot afegir highlights
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.createdBy
        && request.time == request.resource.data.createdAt
        && isValidHighlightCreate(request.resource.data, matchId);

      // üü• 4. Permisos d'actualitzaci√≥: Nom√©s el creador pot modificar els seus highlights
      allow update: if request.auth != null
        && request.auth.uid == resource.data.createdBy
        && isValidHighlightUpdate(request.resource.data, resource.data);

      // ‚ùå 5. Permisos d'eliminaci√≥: Nom√©s el creador pot eliminar els seus highlights
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.createdBy;
    }

    // üì¶ Funcions auxiliars per validaci√≥ de highlights
    function isValidHighlightCreate(data, matchId) {
      return hasRequiredFieldsCreate(data)
        && hasCorrectTypesCreate(data)
        && data.matchId == matchId;
    }

    function isValidHighlightUpdate(newData, oldData) {
      return hasRequiredFieldsUpdate(newData)
        && hasCorrectTypesUpdate(newData)
        && isImmutableFieldsPreserved(newData, oldData);
    }

    // Validaci√≥ de camps obligatoris per creaci√≥
    function hasRequiredFieldsCreate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'timestamp', 'title', 'tag', 'category',
        'tagId', 'tagLabel', 'description', 'createdBy', 'createdAt'
      ]);
    }

    // Validaci√≥ de camps obligatoris per actualitzaci√≥
    function hasRequiredFieldsUpdate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'timestamp', 'title', 'tag', 'category',
        'tagId', 'tagLabel', 'description', 'createdBy', 'createdAt'
      ]);
    }

    // Validaci√≥ de tipus correctes per creaci√≥
    function hasCorrectTypesCreate(data) {
      return data.id is string
        && data.matchId is string
        && data.timestamp is number
        && data.title is string
        && data.tag is string
        && data.category is string
        && data.tagId is string
        && data.tagLabel is string
        && data.description is string
        && data.createdBy is string
        && data.createdAt is timestamp;
    }

    // Validaci√≥ de tipus correctes per actualitzaci√≥
    function hasCorrectTypesUpdate(data) {
      return data.id is string
        && data.matchId is string
        && data.timestamp is number
        && data.title is string
        && data.tag is string
        && data.category is string
        && data.tagId is string
        && data.tagLabel is string
        && data.description is string
        && data.createdBy is string
        && data.createdAt is timestamp;
    }

    // Validaci√≥ que els camps immutables no es modifiquin
    function isImmutableFieldsPreserved(newData, oldData) {
      return newData.createdBy == oldData.createdBy
        && newData.createdAt == oldData.createdAt
        && newData.matchId == oldData.matchId
        && newData.id == oldData.id;
    }

    match /{document=**} {
      // ‚ö†Ô∏è Nom√©s per desenvolupament local (altres col¬∑leccions continuen obertes)
      allow read, write: if true;
    }
  }
}