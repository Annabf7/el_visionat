rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Protect the emails collection from client-side writes. Cloud Functions
    // using the Admin SDK bypass security rules, so functions can still
    // create these documents while clients are prevented from doing so.
    match /emails/{email} {
      // Allow reads if your app needs to read the reserved emails list.
      allow read: if true;
      // Disallow all client-side writes to emails/*. Only server-side
      // operations (Admin SDK used by Cloud Functions) should create these.
      allow create, update, delete: if false;
    }

    // üó≥Ô∏è Regles per Votaci√≥ Setmanal
    // Col¬∑lecci√≥: voting_meta/{docId} - Metadades de votaci√≥
    match /voting_meta/{docId} {
      // Qualsevol usuari autenticat pot llegir les metadades
      allow read: if request.auth != null;
      // Nom√©s el backend (Cloud Functions) pot escriure
      allow write: if false;
    }

    // Col¬∑lecci√≥: voting_jornades/{jornada} - Dades de cada jornada
    match /voting_jornades/{jornada} {
      // Qualsevol usuari autenticat pot llegir les jornades
      allow read: if request.auth != null;
      // Nom√©s el backend (Cloud Functions) pot escriure
      allow write: if false;
    }

    // Col¬∑lecci√≥: vote_counts/{matchId} - Comptadors de vots
    match /vote_counts/{matchId} {
      // Qualsevol usuari autenticat pot llegir els vots
      allow read: if request.auth != null;
      // Els usuaris autenticats poden incrementar/decrementar vots
      allow write: if request.auth != null;
    }

    // Col¬∑lecci√≥: weekly_focus/{docId} - Focus setmanal (guanyador)
    match /weekly_focus/{docId} {
      // Qualsevol usuari autenticat pot llegir el focus
      allow read: if request.auth != null;
      // Nom√©s el backend (Cloud Functions) pot escriure
      allow write: if false;
    }

    // üéØ Regles per Highlights de la feature Visionat
    // Col¬∑lecci√≥: highlights/{matchId}/entries/{highlightId}
    match /highlights/{matchId}/entries/{highlightId} {
      
      // üîê 1. Requisit general: Totes les operacions requereixen autenticaci√≥
      // üü© 2. Permisos de lectura: Qualsevol usuari autenticat pot llegir highlights
      allow read: if request.auth != null;

      // üüß 3. Permisos de creaci√≥: Nom√©s el creador pot afegir highlights
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.createdBy
        && request.time == request.resource.data.createdAt
        && isValidHighlightCreate(request.resource.data, matchId);

      // üü• 4. Permisos d'actualitzaci√≥: Nom√©s el creador pot modificar els seus highlights
      allow update: if request.auth != null
        && request.auth.uid == resource.data.createdBy
        && isValidHighlightUpdate(request.resource.data, resource.data);

      // ‚ùå 5. Permisos d'eliminaci√≥: Nom√©s el creador pot eliminar els seus highlights
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.createdBy;
    }

    // üì¶ Funcions auxiliars per validaci√≥ de highlights
    function isValidHighlightCreate(data, matchId) {
      return hasRequiredFieldsCreate(data)
        && hasCorrectTypesCreate(data)
        && data.matchId == matchId;
    }

    function isValidHighlightUpdate(newData, oldData) {
      return hasRequiredFieldsUpdate(newData)
        && hasCorrectTypesUpdate(newData)
        && isImmutableFieldsPreserved(newData, oldData);
    }

    // Validaci√≥ de camps obligatoris per creaci√≥
    function hasRequiredFieldsCreate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'timestamp', 'title', 'tag', 'category',
        'tagId', 'tagLabel', 'description', 'createdBy', 'createdAt'
      ]);
    }

    // Validaci√≥ de camps obligatoris per actualitzaci√≥
    function hasRequiredFieldsUpdate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'timestamp', 'title', 'tag', 'category',
        'tagId', 'tagLabel', 'description', 'createdBy', 'createdAt'
      ]);
    }

    // Validaci√≥ de tipus correctes per creaci√≥
    function hasCorrectTypesCreate(data) {
      return data.id is string
        && data.matchId is string
        && data.timestamp is number
        && data.title is string
        && data.tag is string
        && data.category is string
        && data.tagId is string
        && data.tagLabel is string
        && data.description is string
        && data.createdBy is string
        && data.createdAt is timestamp;
    }

    // Validaci√≥ de tipus correctes per actualitzaci√≥
    function hasCorrectTypesUpdate(data) {
      return data.id is string
        && data.matchId is string
        && data.timestamp is number
        && data.title is string
        && data.tag is string
        && data.category is string
        && data.tagId is string
        && data.tagLabel is string
        && data.description is string
        && data.createdBy is string
        && data.createdAt is timestamp;
    }

    // Validaci√≥ que els camps immutables no es modifiquin
    function isImmutableFieldsPreserved(newData, oldData) {
      return newData.createdBy == oldData.createdBy
        && newData.createdAt == oldData.createdAt
        && newData.matchId == oldData.matchId
        && newData.id == oldData.id;
    }

    // üó®Ô∏è Regles per Comentaris Col¬∑lectius de la feature Visionat
    // Col¬∑lecci√≥: collective_comments/{matchId}/comments/{commentId}
    match /collective_comments/{matchId}/comments/{commentId} {
      
      // üîê 1. Requisit general: Totes les operacions requereixen autenticaci√≥
      // üü© 2. Permisos de lectura: Qualsevol usuari autenticat pot llegir comentaris
      allow read: if request.auth != null;

      // üüß 3. Permisos de creaci√≥: Nom√©s el creador pot afegir comentaris
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.createdBy
        && request.time == request.resource.data.createdAt
        && isValidCommentCreate(request.resource.data, matchId);

      // üü• 4. Permisos d'actualitzaci√≥: El creador pot modificar el contingut, qualsevol pot fer like
      allow update: if request.auth != null
        && (
          // El creador pot modificar el contingut del comentari
          (request.auth.uid == resource.data.createdBy 
           && isValidCommentUpdate(request.resource.data, resource.data))
          ||
          // Qualsevol usuari pot fer/desfer like (nom√©s canvien likes i likedBy)
          isValidLikeToggle(request.resource.data, resource.data, request.auth.uid)
        );

      // ‚ùå 5. Permisos d'eliminaci√≥: Nom√©s el creador pot eliminar els seus comentaris
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.createdBy;
    }

    // üì¶ Funcions auxiliars per validaci√≥ de comentaris col¬∑lectius
    function isValidCommentCreate(data, matchId) {
      return hasRequiredFieldsCommentCreate(data)
        && hasCorrectTypesCommentCreate(data)
        && data.matchId == matchId
        && data.likes == 0
        && data.likedBy.size() == 0
        && data.isEdited == false;
    }

    function isValidCommentUpdate(newData, oldData) {
      return hasRequiredFieldsCommentUpdate(newData)
        && hasCorrectTypesCommentUpdate(newData)
        && isImmutableCommentFieldsPreserved(newData, oldData)
        // Si s'edita el contingut, marcar com editat
        && (newData.content == oldData.content || newData.isEdited == true);
    }

    function isValidLikeToggle(newData, oldData, userId) {
      return onlyLikeFieldsChanged(newData, oldData)
        && isValidLikeOperation(newData, oldData, userId);
    }

    // Validaci√≥ que nom√©s canvi√Øn els camps de like
    function onlyLikeFieldsChanged(newData, oldData) {
      let unchangedFields = newData.diff(oldData).unchangedKeys();
      let requiredUnchanged = [
        'id', 'matchId', 'content', 'tagId', 'tagLabel', 
        'createdBy', 'createdByName', 'createdAt', 'isEdited'
      ];
      return unchangedFields.hasAll(requiredUnchanged);
    }

    // Validaci√≥ de l'operaci√≥ de like (afegir o treure like)
    function isValidLikeOperation(newData, oldData, userId) {
      let oldLikedBy = oldData.likedBy;
      let newLikedBy = newData.likedBy;
      let wasLiked = oldLikedBy.hasAny([userId]);
      let isNowLiked = newLikedBy.hasAny([userId]);
      
      // Afegir like: l'usuari no tenia like i ara s√≠
      let addingLike = !wasLiked && isNowLiked 
        && newData.likes == oldData.likes + 1
        && newLikedBy.toSet().difference(oldLikedBy.toSet()) == [userId].toSet();
      
      // Treure like: l'usuari tenia like i ara no
      let removingLike = wasLiked && !isNowLiked 
        && newData.likes == oldData.likes - 1
        && oldLikedBy.toSet().difference(newLikedBy.toSet()) == [userId].toSet();
      
      return addingLike || removingLike;
    }

    // Validaci√≥ de camps obligatoris per creaci√≥ de comentaris
    function hasRequiredFieldsCommentCreate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'content', 'tagId', 'tagLabel',
        'createdBy', 'createdByName', 'createdAt', 'likes', 'likedBy', 'isEdited'
      ]);
    }

    // Validaci√≥ de camps obligatoris per actualitzaci√≥ de comentaris
    function hasRequiredFieldsCommentUpdate(data) {
      return data.keys().hasAll([
        'id', 'matchId', 'content', 'tagId', 'tagLabel',
        'createdBy', 'createdByName', 'createdAt', 'likes', 'likedBy', 'isEdited'
      ]);
    }

    // Validaci√≥ de tipus correctes per creaci√≥ de comentaris
    function hasCorrectTypesCommentCreate(data) {
      return data.id is string
        && data.matchId is string
        && data.content is string
        && data.tagId is string
        && data.tagLabel is string
        && data.createdBy is string
        && data.createdByName is string
        && data.createdAt is timestamp
        && data.likes is number
        && data.likedBy is list
        && data.isEdited is bool;
    }

    // Validaci√≥ de tipus correctes per actualitzaci√≥ de comentaris
    function hasCorrectTypesCommentUpdate(data) {
      return data.id is string
        && data.matchId is string
        && data.content is string
        && data.tagId is string
        && data.tagLabel is string
        && data.createdBy is string
        && data.createdByName is string
        && data.createdAt is timestamp
        && data.likes is number
        && data.likedBy is list
        && data.isEdited is bool;
    }

    // Validaci√≥ que els camps immutables de comentaris no es modifiquin
    function isImmutableCommentFieldsPreserved(newData, oldData) {
      return newData.createdBy == oldData.createdBy
        && newData.createdAt == oldData.createdAt
        && newData.matchId == oldData.matchId
        && newData.id == oldData.id
        && newData.createdByName == oldData.createdByName
        && newData.tagId == oldData.tagId
        && newData.tagLabel == oldData.tagLabel;
    }

    // üîí Regles per Personal Analysis de la feature Visionat
    // Col¬∑lecci√≥: personal_analysis/{analysisId}
    match /personal_analysis/{analysisId} {
      
      // üîê 1. Requisit general: Totes les operacions requereixen autenticaci√≥
      // üìö 2. Permisos de lectura: Nom√©s l'usuari propietari pot llegir els seus apunts
      allow read: if request.auth != null
        && request.auth.uid == resource.data.userId;

      // üÜï 3. Permisos de creaci√≥: Nom√©s l'usuari pot crear els seus propis apunts
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId
        && request.time == request.resource.data.createdAt
        && isValidPersonalAnalysisCreate(request.resource.data);

      // ‚úèÔ∏è 4. Permisos d'actualitzaci√≥: Nom√©s l'usuari propietari pot modificar els seus apunts
      allow update: if request.auth != null
        && request.auth.uid == resource.data.userId
        && request.auth.uid == request.resource.data.userId
        && isValidPersonalAnalysisUpdate(request.resource.data, resource.data);

      // üóëÔ∏è 5. Permisos d'eliminaci√≥: Nom√©s l'usuari propietari pot eliminar els seus apunts
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.userId;
    }

    // üì¶ Funcions auxiliars per validaci√≥ d'apunts personals
    function isValidPersonalAnalysisCreate(data) {
      return hasRequiredFieldsPersonalAnalysisCreate(data)
        && hasCorrectTypesPersonalAnalysisCreate(data);
    }

    function isValidPersonalAnalysisUpdate(newData, oldData) {
      return hasRequiredFieldsPersonalAnalysisUpdate(newData)
        && hasCorrectTypesPersonalAnalysisUpdate(newData)
        && isImmutablePersonalAnalysisFieldsPreserved(newData, oldData);
    }

    // Validaci√≥ de camps obligatoris per creaci√≥ d'apunts personals
    function hasRequiredFieldsPersonalAnalysisCreate(data) {
      return data.keys().hasAll([
        'userId', 'matchId', 'jornadaId', 'text', 'tags',
        'createdAt', 'userDisplayName', 'isEdited'
      ]);
    }

    // Validaci√≥ de camps obligatoris per actualitzaci√≥ d'apunts personals
    function hasRequiredFieldsPersonalAnalysisUpdate(data) {
      return data.keys().hasAll([
        'userId', 'matchId', 'jornadaId', 'text', 'tags',
        'createdAt', 'userDisplayName', 'isEdited'
      ]);
    }

    // Validaci√≥ de tipus correctes per creaci√≥ d'apunts personals
    function hasCorrectTypesPersonalAnalysisCreate(data) {
      return data.userId is string
        && data.matchId is string
        && data.jornadaId is string
        && data.text is string
        && data.tags is list
        && data.createdAt is timestamp
        && data.userDisplayName is string
        && data.isEdited is bool;
    }

    // Validaci√≥ de tipus correctes per actualitzaci√≥ d'apunts personals
    function hasCorrectTypesPersonalAnalysisUpdate(data) {
      return data.userId is string
        && data.matchId is string
        && data.jornadaId is string
        && data.text is string
        && data.tags is list
        && data.createdAt is timestamp
        && data.userDisplayName is string
        && data.isEdited is bool;
    }

    // Validaci√≥ que els camps immutables d'apunts personals no es modifiquin
    function isImmutablePersonalAnalysisFieldsPreserved(newData, oldData) {
      return newData.userId == oldData.userId
        && newData.matchId == oldData.matchId
        && newData.jornadaId == oldData.jornadaId
        && newData.createdAt == oldData.createdAt
        && newData.userDisplayName == oldData.userDisplayName;
    }

    match /{document=**} {
      // ‚ö†Ô∏è Nom√©s per desenvolupament local (altres col¬∑leccions continuen obertes)
      allow read, write: if true;
    }
  }
}